import{URL,isJson,newTokenData,loginMdl,ht}from"./script.js";const commentInput=document.querySelector("#comment-area"),commentInfo=document.querySelector("#comment-info"),commentBtn=document.querySelector("#comment-btn"),replyBar=document.querySelector("#reply-bar"),editBar=document.querySelector("#edit-bar"),attrBar=document.querySelector(".comment-attr"),commentBox=document.querySelector(".comments-box"),articleId=document.querySelector("[name='article_id']").value,toast=document.getElementById("message-toast"),toastBody=toast.querySelector(".toast-body");function replyClick(){const t=this.getAttribute("data-parent-id");commentInfo.setAttribute("data-parent-id",t),commentInfo.setAttribute("data-edit-id","0"),commentInfo.setAttribute("data-method","add");const e=this.getAttribute("data-mention");attrBar.style.display="block",replyBar.style.display="inline-flex",editBar.style.display="none",replyBar.querySelector(".reply-to").textContent="Replying to "+e,commentBtn.textContent="Add Reply",commentInput.value="@"+e+" ",commentInput.focus()}function editClick(){const t=this.querySelector("a"),e=t.getAttribute("data-comment-id"),n=t.getAttribute("data-type"),o=n[0].toUpperCase()+n.substring(1);commentInfo.setAttribute("data-method","edit"),commentInfo.setAttribute("data-edit-id",e),commentInfo.setAttribute("data-parent-id","0"),attrBar.style.display="block",editBar.style.display="inline-flex",replyBar.style.display="none",commentBtn.textContent="Edit "+o,commentInput.value=t.getAttribute("data-content"),commentInput.focus(),editBar.querySelector(".edit-info").textContent="Editing "+o}function likeComment(){const t=this.getAttribute("data-comment-id"),e=newTokenData();fetch(`${URL}/ajax/article/toggle-comment-like/${t}/${articleId}`,{method:"POST",body:e}).then(t=>t.text()).then(e=>{if(isJson(e)){const e=this.querySelector(".count-heart-"+t),n=parseInt(e.innerHTML),o=this.classList.contains("reacted")?n-1:n+1;e.innerHTML=o,this.classList.toggle("reacted")}else loginMdl()})}function deleteComment(){const t=this.querySelector("a").getAttribute("data-comment-id"),e=newTokenData();fetch(`${URL}/ajax/article/delete-comment/${t}`,{method:"POST",body:e}).then(t=>t.text()).then(e=>{if(isJson(e)){this.closest(".row").remove(),document.querySelector("#reply-"+t).remove(),toastBody.innerHTML="Deleted Comment",new bootstrap.Toast(toast,{delay:2e3}).show()}})}function addListeners(){commentInfo.setAttribute("data-parent-id","0"),commentInfo.setAttribute("data-edit-id","0"),commentInfo.setAttribute("data-method","add"),editBar.style.display="none",replyBar.style.display="none",commentInput.value="",attrBar.style.display="none",commentBtn.textContent="Add Comment",commentInput.blur(),document.querySelectorAll(".reply-btn").forEach(t=>{t.getAttribute("data-set")?t.removeEventListener("click",replyClick):t.setAttribute("data-set",!0),t.addEventListener("click",replyClick)}),document.querySelectorAll(".edit-comment").forEach(t=>{t.getAttribute("data-set")?t.removeEventListener("click",editClick):t.setAttribute("data-set",!0),t.addEventListener("click",editClick)}),document.querySelectorAll(".react-heart").forEach(t=>{t.getAttribute("data-set")?t.removeEventListener("click",likeComment):t.setAttribute("data-set",!0),t.addEventListener("click",likeComment)}),document.querySelectorAll(".delete-comment").forEach(t=>{t.getAttribute("data-set")?t.removeEventListener("click",deleteComment):t.setAttribute("data-set",!0),t.addEventListener("click",deleteComment)})}commentInput.addEventListener("input",()=>{""===commentInput.value.trim()?(commentBtn.style.opacity=.5,commentBtn.disabled=!0):(commentBtn.style.opacity=1,commentBtn.disabled=!1),commentInput.style.height="1px",commentInput.style.height=commentInput.scrollHeight+"px"}),document.querySelectorAll(".expand-replies").forEach(t=>{t.addEventListener("click",function(){const t=this.getAttribute("data-comment-id");document.querySelector(`#reply-${t}`).classList.toggle("none"),this.querySelector("i").classList.toggle("fa-angle-down"),this.querySelector("i").classList.toggle("fa-angle-up")})}),addListeners(),document.querySelector(".cancel-reply").addEventListener("click",function(){commentInfo.setAttribute("data-parent-id","0"),commentInfo.setAttribute("data-method","add"),replyBar.style.display="none",commentInput.value="",attrBar.style.display="none",commentBtn.textContent="Add Comment",commentInput.blur()}),document.querySelector(".cancel-edit").addEventListener("click",function(){commentInfo.setAttribute("data-parent-id","0"),commentInfo.setAttribute("data-edit-id","0"),commentInfo.setAttribute("data-method","add"),editBar.style.display="none",commentInput.value="",attrBar.style.display="none",commentBtn.textContent="Add Comment",commentInput.blur()}),document.querySelector("#comment-btn").addEventListener("click",function(){if("add"===commentInfo.getAttribute("data-method")){const t=commentInfo.getAttribute("data-parent-id"),e=newTokenData({article_id:articleId,content:commentInput.value});fetch(`${URL}/ajax/article/add-comment/${t}`,{method:"POST",body:e}).then(t=>t.text()).then(e=>{if(isJson(e)){const n=JSON.parse(e);if(200===n.status){const e=n.comment;"0"===t?(document.querySelector("#comments-box").innerHTML+=e,toastBody.innerHTML="Added Comment"):(document.querySelector(`#reply-${t}`).innerHTML+=e,toastBody.innerHTML="Added Reply"),addListeners()}else delete n.status,toastBody.innerHTML=`${n[Object.keys(n)[0]]}`;new bootstrap.Toast(toast,{delay:2e3}).show()}else loginMdl()})}else{const t=commentInfo.getAttribute("data-edit-id"),e=newTokenData({content:commentInput.value});fetch(`${URL}/ajax/article/edit-comment/${t}`,{method:"POST",body:e}).then(t=>t.text()).then(e=>{if(isJson(e)){const n=JSON.parse(e);200===n.status?(toastBody.innerHTML="Edited Comment",document.querySelector("#username-"+t).innerHTML=n.new_time+"&nbsp; (edited)",document.querySelector("#content-"+t).textContent=commentInput.value,document.querySelector(`.edit-comment a[data-comment-id='${t}']`).setAttribute("data-content",ht(commentInput.value)),addListeners()):(delete n.status,toastBody.innerHTML=`${n[Object.keys(n)[0]]}`),new bootstrap.Toast(toast,{delay:2e3}).show()}})}});